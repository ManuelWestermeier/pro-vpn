<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Proxy target — set origin</title>
    <style>
        :root {
            --bg: #0f1724;
            --card: #0b1220;
            --accent: #7c3aed;
            --muted: #9aa4b2;
            --glass: rgba(255, 255, 255, 0.04);
            --radius: 14px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background:
                radial-gradient(800px 400px at 10% 10%, rgba(124, 58, 237, 0.12), transparent 6%),
                linear-gradient(180deg, #071024 0%, #071426 40%, #04101a 100%);
            color: #e6eef8;
            padding: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            width: 100%;
            max-width: 920px;
            padding: 22px;
            border-radius: 16px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(255, 255, 255, 0.03);
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6);
        }

        header h1 {
            margin: 0;
            font-size: 20px;
        }

        header p {
            margin: 6px 0 16px;
            color: var(--muted);
        }

        form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="text"] {
            flex: 1;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.03);
            padding: 12px 14px;
            border-radius: 10px;
            color: inherit;
            font-size: 15px;
            outline: none;
        }

        input[type="text"]::placeholder {
            color: #94a3b8;
        }

        button.primary {
            background: linear-gradient(180deg, var(--accent), #5b21b6);
            border: none;
            padding: 11px 14px;
            color: white;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(124, 58, 237, 0.14), inset 0 -2px 6px rgba(0, 0, 0, 0.15);
        }

        .note {
            color: var(--muted);
            margin-top: 12px;
            font-size: 13px;
        }

        .history-wrap {
            margin-top: 18px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search {
            flex: 1;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.03);
            color: inherit;
            outline: none;
        }

        .list {
            margin-top: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 420px;
            overflow: auto;
            padding-right: 6px;
        }

        .item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        .fav {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--muted);
            background: rgba(255, 255, 255, 0.02);
        }

        .meta {
            flex: 1;
            min-width: 0;
        }

        .meta .url {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .meta .sm {
            margin-top: 4px;
            color: var(--muted);
            font-size: 12px;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .controls button {
            border: none;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
        }

        .visit {
            background: linear-gradient(90deg, rgba(124, 58, 237, 0.14), rgba(91, 33, 182, 0.14));
            color: #eaf0ff;
            padding: 8px 10px;
            border-radius: 8px;
            font-weight: 600;
        }

        .empty {
            text-align: center;
            padding: 28px;
            color: var(--muted);
        }

        @media (max-width:720px) {
            .card {
                padding: 16px
            }

            .item {
                flex-direction: column;
                align-items: stretch
            }

            .controls {
                justify-content: flex-end
            }
        }
    </style>
</head>

<body>
    <div class="card" role="main">
        <header>
            <h1>Set proxy target</h1>
            <p>Enter the origin (domain or full URL) you want your requests proxied to. Afterwards you'll be redirected
                to that origin's path so proxying begins.</p>
        </header>

        <form id="setForm" autocomplete="off">
            <input id="urlInput" name="url" type="text" placeholder="https://example.com:8080 or example.com"
                required />
            <button class="primary" type="submit">Set target</button>
        </form>

        <div class="note">History is stored locally in your browser. Visiting an entry will set it as the origin and
            navigate to its path.</div>

        <div class="history-wrap">
            <div style="font-weight:600">History</div>
            <div class="search">
                <input id="searchInput" placeholder="Filter history..." />
            </div>
            <button id="refreshBtn" title="Refresh">⟳</button>
            <button id="clearBtn" title="Clear history">Clear</button>
        </div>

        <div class="list" id="list"></div>
        <div id="empty" class="empty" style="display:none">No history yet — set a target or visit a URL to add entries.
        </div>
    </div>

    <script>
        (function () {
            const STORAGE_KEY = 'mw_proxy_history_v1';

            const load = () => {
                try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
            };
            const save = (list) => { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); };

            function normalize(u) {
                try {
                    if (!/^[a-zA-Z][a-zA-Z\d+\-.]*:\/\//.test(u)) u = 'http://' + u;
                    const parsed = new URL(u);
                    if ((parsed.protocol === 'http:' && parsed.port === '80') || (parsed.protocol === 'https:' && parsed.port === '443')) parsed.port = '';
                    return parsed.href;
                } catch { return u; }
            }

            function nowISO() { return new Date().toISOString(); }

            function add(url) {
                if (!url) return;
                const href = normalize(url);
                const list = load();
                const idx = list.findIndex(x => x.url === href);
                if (idx !== -1) {
                    const it = list.splice(idx, 1)[0];
                    it.lastVisited = nowISO();
                    it.visits = (it.visits || 0) + 1;
                    list.unshift(it);
                } else {
                    list.unshift({ url: href, addedAt: nowISO(), lastVisited: nowISO(), visits: 1 });
                }
                save(list);
                render();
            }

            function remove(url) {
                const list = load().filter(x => x.url !== url);
                save(list);
                render();
            }

            function clearAll() {
                if (!confirm('Clear history?')) return;
                localStorage.removeItem(STORAGE_KEY);
                render();
            }

            function fmt(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }
            function faviconText(url) {
                try { return new URL(url).hostname.split('.').slice(-2, -1)[0].slice(0, 1).toUpperCase(); } catch { return '?'; }
            }

            function render() {
                const q = (document.getElementById('searchInput').value || '').toLowerCase();
                const container = document.getElementById('list');
                const empty = document.getElementById('empty');
                let list = load();
                if (q) list = list.filter(it => it.url.toLowerCase().includes(q));
                container.innerHTML = '';
                if (!list.length) { empty.style.display = ''; return; } else empty.style.display = 'none';
                for (const item of list) {
                    const row = document.createElement('div'); row.className = 'item';
                    const fav = document.createElement('div'); fav.className = 'fav'; fav.textContent = faviconText(item.url);
                    const meta = document.createElement('div'); meta.className = 'meta';
                    const urlLine = document.createElement('div'); urlLine.className = 'url'; urlLine.textContent = item.url;
                    const sm = document.createElement('div'); sm.className = 'sm'; sm.textContent = `added ${fmt(item.addedAt)} • visits ${item.visits || 0} • last ${fmt(item.lastVisited)}`;
                    meta.appendChild(urlLine); meta.appendChild(sm);

                    const controls = document.createElement('div'); controls.className = 'controls';
                    const visit = document.createElement('button'); visit.className = 'visit'; visit.textContent = 'Visit';
                    visit.onclick = async () => {
                        // set server-side origin
                        try {
                            const params = new URLSearchParams(); params.set('url', item.url);
                            await fetch('/proxy/api/set', { method: 'POST', body: params });
                        } catch (e) {
                            // still navigate even if server set fails
                            console.warn('Set failed', e);
                        }
                        add(item.url);
                        try {
                            const u = new URL(item.url);
                            const path = (u.pathname || '/') + (u.search || '');
                            window.location.href = path;
                        } catch {
                            window.location.href = '/';
                        }
                    };

                    const del = document.createElement('button'); del.innerHTML = '&#x2716;'; del.title = 'Delete';
                    del.onclick = () => remove(item.url);

                    controls.appendChild(visit); controls.appendChild(del);
                    row.appendChild(fav); row.appendChild(meta); row.appendChild(controls);
                    container.appendChild(row);
                }
            }

            // form submit
            document.getElementById('setForm').addEventListener('submit', async (ev) => {
                ev.preventDefault();
                let v = document.getElementById('urlInput').value.trim();
                if (!v) return;
                const normalized = normalize(v);
                add(normalized);
                try {
                    const params = new URLSearchParams(); params.set('url', normalized);
                    await fetch('/proxy/api/set', { method: 'POST', body: params });
                } catch (e) {
                    console.warn('Server set failed', e);
                }
                try {
                    const u = new URL(normalized);
                    const path = (u.pathname || '/') + (u.search || '');
                    window.location.href = path;
                } catch {
                    window.location.href = '/';
                }
            });

            document.getElementById('searchInput').addEventListener('input', render);
            document.getElementById('refreshBtn').addEventListener('click', render);
            document.getElementById('clearBtn').addEventListener('click', clearAll);

            // initial render
            render();
        })();
    </script>
</body>

</html>